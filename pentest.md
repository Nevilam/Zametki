# Пентест: практичный гайд (по структуре HackTricks), с упором на безопасность и легальный scope
*Формат: чеклисты + безопасные команды (без эксплуатационных payload’ов и “боевых” инструкций).*
DIRB+MASSCAN\nmap
> Важно: делай это **только** по письменному разрешению (scope/ROE). Ниже — про методологию, триаж и проверку уязвимостей, а не про “как взломать”.

---

## Содержание
1. [Подготовка: Scope, ROE, цели](#1-подготовка-scope-roe-цели)
2. [Структура процесса (по HackTricks)](#2-структура-процесса-по-hacktricks)
3. [Быстрый старт: что сделать за первый час](#3-быстрый-старт-что-сделать-за-первый-час)
4. [External recon и asset discovery](#4-external-recon-и-asset-discovery)
5. [Internal recon (если есть доступ в сеть)](#5-internal-recon-если-есть-доступ-в-сеть)
6. [Port scan и service discovery](#6-port-scan-и-service-discovery)
7. [Энумерация сервисов (по портам)](#7-энумерация-сервисов-по-портам)
8. [Валидация уязвимостей (безопасно)](#8-валидация-уязвимостей-безопасно)
9. [Post-exploitation (границы и минимальные действия)](#9-post-exploitation-границы-и-минимальные-действия)
10. [Pivoting и сегментация (концептуально)](#10-pivoting-и-сегментация-концептуально)
11. [Документация и отчёт](#11-документация-и-отчёт)
12. [Шаблон структуры проекта](#12-шаблон-структуры-проекта)
13. [Мини-чеклисты](#13-мини-чеклисты)

---

## 1) Подготовка: Scope, ROE, цели
### 1.1 Scope (что можно тестировать)
- Диапазоны IP / домены / подсети / приложения
- Временные окна (когда можно шуметь)
- Запрещённые действия (например: DoS, фишинг, эксплуатация prod-БД)
- Контактные лица и эскалация инцидентов

### 1.2 ROE (rules of engagement)
- допустимая интенсивность сканирования (rate limits)
- допустимые инструменты
- требования к логированию (что сохранять)
- критерии “успеха” (цели теста)

### 1.3 Артефакты, которые нужно собирать с первого шага
- Все результаты сканов (сырьём + отчётной формой)
- Снимки экранов/ответы сервера (там, где важно)
- Хэши файлов (если получаешь артефакты)
- Точные таймстампы

---

## 2) Структура процесса (по HackTricks)
HackTricks предлагает “сквозной” workflow: **discovery → scanning → enumeration/pentesting services → (если допустимо) gaining access → privilege escalation → post/pivoting**. citeturn1view0  
А также удобный индекс “Pentesting” по сервисам, отсортированный по портам. citeturn0search1

В этом гайде мы сохраняем эту структуру, но:
- **не даём** эксплуатационные полезные нагрузки/шеллы,
- делаем упор на **энтерацию, доказательство, риски и ремедиацию**.

---

## 3) Быстрый старт: что сделать за первый час
1) Собрать scope/ROE в один файл (чтобы не ошибиться).  
2) Составить список активов (домены, IP, подсети).  
3) Настроить папку проекта и логирование вывода команд.  
4) Запустить “широкий” discovery (host discovery) и первичный port scan по top-портам.  
5) Зафиксировать “горячие” сервисы: VPN, RDP/SSH, web, AD, почта.

---


## 3.5 Сканирование диапазона в самом начале (masscan → nmap)
Идея: **masscan** быстро находит “живые порты” по диапазону, а **nmap** потом аккуратно уточняет сервисы/версии и делает скриптовую энумерацию в рамках ROE.

> ⚠️ masscan **очень шумный**. Используй только если это явно разрешено ROE, и обязательно ограничивай скорость (`--rate`) и порты. На проде лучше начинать с nmap с умеренным темпом.

### Шаг 1 — определить диапазон и сохранить цели
```bash
# Пример диапазона
RANGE="10.10.0.0/16"
mkdir -p scans/masscan scans/nmap
```

### Шаг 2 — быстрый первичный проход masscan (только discovery портов)
**Вариант A: top-порты (минимальный)**
```bash
sudo masscan "$RANGE" -p80,443,22,445,3389,53,389,636,1433,3306 \
  --rate 1000 -oX scans/masscan/quick.xml
```

**Вариант B: широкий TCP (шумнее)**
```bash
sudo masscan "$RANGE" -p1-65535 --rate 1000 -oX scans/masscan/alltcp.xml
```

> Подбирай `--rate` под сеть и ROE (часто 100–1000 уже достаточно).  
> Если есть whitelist/blacklist — используй `--include`/`--exclude` файлы (в зависимости от версии masscan).

### Шаг 3 — извлечь хосты/порты из результатов masscan
Удобно получить список хостов:
```bash
# Вытянуть IP из XML (быстро и грубо)
rg -o "addr=\"([0-9]{1,3}\.){3}[0-9]{1,3}\"" scans/masscan/quick.xml \
  | rg -o "([0-9]{1,3}\.){3}[0-9]{1,3}" | sort -u > 01_assets/alive_hosts.txt
```

Или (если есть `xsltproc`) можно сделать красивее, но главное — получить `alive_hosts.txt`.

### Шаг 4 — уточняющий nmap по найденным хостам
**Top 1000 портов + версии:**
```bash
nmap -iL 01_assets/alive_hosts.txt -sV -T3 --version-light \
  -oA scans/nmap/top1k_from_masscan
```

**Точечно по портам из masscan (рекомендуется):**
1) собрать список “уникальных портов” из XML (грубо):
```bash
rg -o 'portid="[0-9]+"' scans/masscan/quick.xml | rg -o "[0-9]+" | sort -n | uniq \
  | paste -sd, - > 01_assets/ports.txt
```
2) прогнать nmap только по ним:
```bash
PORTS="$(cat 01_assets/ports.txt)"
nmap -iL 01_assets/alive_hosts.txt -p "$PORTS" -sV -T3 --version-light \
  -oA scans/nmap/ports_from_masscan
```

### Шаг 5 — (опционально) базовые nmap NSE скрипты безопасного профиля
> NSE-скрипты могут быть шумными. Выбирай безопасные категории и избегай всего, что меняет состояние.
```bash
nmap -iL 01_assets/alive_hosts.txt -p "$PORTS" -sV -T3 \
  --script "safe,default" -oA scans/nmap/nse_safe
```

### Что фиксировать как результат этапа
- `alive_hosts.txt` — список доступных хостов
- `ports.txt` — список найденных портов (уникальные)
- `*.nmap/*.xml` — сырые результаты nmap для отчёта и воспроизводимости


## 4) External recon и asset discovery
### 4.1 Сбор доменов/поддоменов (разрешённый OSINT)
- зона ответственности: только домены из scope
- фиксируй источники (какой инструмент нашёл какой hostname)

> Команды ниже — **безопасные** (не эксплуатируют), но могут быть шумными при большом объёме.

**DNS базовая проверка**
```bash
dig A example.com +short
dig MX example.com +short
dig TXT example.com +short
```

**Пассивный сбор поддоменов (зависит от toolchain)**
- amass (passive)
- subfinder
- crt.sh/CT logs (через инструменты/скрипты)

*(Инструменты выбирай по ROE: если нельзя внешние сервисы — не используй их.)*

### 4.2 HTTP(S) инвентаризация
- какие хосты отвечают по 80/443
- какие заголовки/технологии (без агрессивного fuzzing)

```bash
# Быстрый хедер-чек (на список URL)
while read -r u; do echo "### $u"; curl -skI --max-time 10 "$u" | head; done < urls.txt
```

---

## 5) Internal recon (если есть доступ в сеть)
HackTricks явно выделяет отдельный этап “discovering hosts inside the network / having fun with the network (internal)”. citeturn1view0

### 5.1 Host discovery (аккуратно по rate)
```bash
# ICMP discovery (не везде работает из-за фильтрации)
fping -a -g 10.10.0.0/16 2>/dev/null | tee alive.txt
```

Если ICMP заблокирован — используешь ARP (в одной L2) или TCP discovery в рамках ROE.

---

## 6) Port scan и service discovery
HackTricks делает это отдельным шагом “Port Scan - Service discovery”. citeturn1view0

### 6.1 Nmap: “безопасный” базовый профиль
```bash
# TOP 1000 портов + версии
nmap -sV -T3 --version-light -oA scans/top1k 10.10.10.10

# Полный TCP (шумнее)
nmap -p- -sV -T3 --min-rate 200 -oA scans/fulltcp 10.10.10.10
```

Рекомендации:
- `-T3` — умеренно
- `--min-rate` используй осторожно и только если ROE позволяет
- сохраняй `-oA`, чтобы были .nmap/.gnmap/.xml

### 6.2 Что вытаскивать из результатов
- список открытых портов
- продукт + версия
- TLS: сертификат/SNI
- баннеры и редиректы

---

## 7) Энумерация сервисов (по портам)
HackTricks предлагает “Pentesting services” как основную часть работы, с гайдами по каждому сервису в индексе. citeturn1view0turn0search1

Ниже — универсальная матрица: **что собирать** для любого сервиса, прежде чем говорить “уязвимо”.

### 7.1 Универсальный чеклист энумерации
Для каждого `<host:port>`:
- идентификация: продукт/версия/баннеры
- аутентификация: есть ли? какие методы?
- доступность “анонимного” доступа
- дефолтные конфиги (guest/anonymous/share)
- известные CVE под версию (но **валидировать** аккуратно)
- misconfiguration: слабые настройки, лишние права, открытые панели

### 7.2 Web (80/443)
Безопасный минимум:
- карта приложения (эндпоинты, формы, панели)
- технологии (framework, server, WAF)
- auth flows (SSO/OAuth), роли
- загрузки файлов, админки, API

```bash
# Сбор заголовков + редиректов
curl -skIL https://target.tld | sed -n '1,30p'
```

> Fuzzing/dirbusting — потенциально шумно; делай только если разрешено и с лимитами.

### 7.3 SMB/AD (445/389/636) — только в рамках внутреннего пентеста
Цель: инвентаризация домена/сервисов/политик.
- какие домены/лес
- какие shares доступны
- какие политики паролей/аутентификации (по разрешённым методам)

### 7.4 SSH/RDP/VPN
- версии
- MFA/ограничения
- брутфорс **только если ROE явно разрешает** (и с лимитами)

---

## 8) Валидация уязвимостей (безопасно)
HackTricks предлагает шаг “Searching service version exploits”. citeturn1view0  
Важно: “нашёл CVE по версии” ≠ “уязвимо”. Правильная валидация:

### 8.1 Иерархия доказательств (от безопасного к более рискованному)
1) **Конфигурационное доказательство** (скрин/ответ сервера/настройка)
2) **Read-only PoC** (например: утечка информации без изменений)
3) **Контролируемая проверка** (минимально влияющая на систему)
4) **Эксплуатация** (только если разрешено и есть план отката)

### 8.2 Как оформлять finding
- *What*: что обнаружено
- *Impact*: к чему приводит
- *Evidence*: логи/скрин/ответы/команды
- *Repro steps*: аккуратно, без “оружейных” деталей
- *Remediation*: конкретные исправления
- *CVSS*: при необходимости (и обоснование)

---

## 9) Post-exploitation (границы и минимальные действия)
HackTricks включает этапы “POST” и “Persistence / Pivoting”. citeturn1view0  
В реальном пентесте **post** часто ограничен ROE. Минимальный безопасный набор:

- подтвердить уровень доступа (роль/права)
- собрать только релевантные доказательства (минимизация данных)
- проверить наличие “path to crown jewels” (без лишнего ущерба)
- не внедрять персистентность, если не разрешено

---

## 10) Pivoting и сегментация (концептуально)
Pivoting нужен, когда актив доступен только через скомпрометированную точку. HackTricks выносит pivoting отдельным этапом. citeturn1view0

Что фиксировать:
- откуда куда был доступ
- какие маршруты/туннели использовались (в рамках ROE)
- какие подсети были обнаружены

---

## 11) Документация и отчёт
### 11.1 Что должно быть в финальном отчёте
- Executive summary (для бизнеса)
- Scope/ROE/ограничения
- Методология (шаги)
- Findings (по критичности)
- Рекомендации/roadmap
- Приложения: логи, сканы, доказательства

### 11.2 Тонкости
- всегда отделяй “найдено” от “предполагается”
- избегай хранения чувствительных данных, если не нужно
- храни артефакты в зашифрованном виде (если требуется политикой)

---

## 12) Шаблон структуры проекта
```text
pentest_YYYYMMDD_client/
  00_scope/
    scope.md
    roe.md
    contacts.md
  01_assets/
    targets.txt
    urls.txt
    notes.md
  02_scans/
    nmap/
      top1k.*
      fulltcp.*
    web/
      headers.txt
  03_enum/
    service_notes.md
    screenshots/
  04_findings/
    findings.md
    evidence/
  05_report/
    report.md
    executive_summary.md
```

---

## 13) Мини-чеклисты
### 13.1 До начала
- [ ] Scope/ROE подписаны
- [ ] Канал связи и “stop button”
- [ ] Логи и хранение артефактов
- [ ] Rate limits согласованы

### 13.2 На каждом хосте
- [ ] порты/сервисы/версии
- [ ] аутентификация/роли
- [ ] конфиги/ошибки/инфоутечки
- [ ] CVE-ориентир → **валидация**
- [ ] доказательства + ремедиация

### 13.3 Перед сдачей
- [ ] все findings имеют evidence
- [ ] рекомендации конкретные и проверяемые
- [ ] нет лишних секретов в приложениях отчёта

---

## Полезная навигация по HackTricks
- “Pentesting Methodology” — сквозной workflow. citeturn1view0  
- “Index → Pentesting” — сервисы по портам (SMB/DNS/HTTP/SMTP/… ). citeturn0search1

